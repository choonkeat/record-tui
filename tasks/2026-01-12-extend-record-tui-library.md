# Extend record-tui to be Library-Friendly

**Branch**: `expose-api`
**Goal**: Make record-tui a library that swe-swe can import to generate HTML playback pages for terminal recordings, supporting both macOS and Linux `script` formats.

---

## Phase 1: Fix Go Version & Basic Library Structure [DONE]

**Commit**: `ca9c804` - fix: lower Go version requirement from 1.25.3 to 1.22

### What Will Be Achieved
The record-tui package will be importable by other Go projects via `go get github.com/choonkeat/record-tui@<commit>`.

### Small Steps

1. **Fix go.mod version**: Change `go 1.25.3` â†’ `go 1.22` (valid version)
2. **Verify the fix**: Run `go mod tidy` to ensure it's valid
3. **Run existing tests**: Ensure nothing breaks

### Verification (TDD Style)

**Red**: Currently, importing fails:
```
go get github.com/choonkeat/record-tui@78fe0ba
# Error: requires go >= 1.25.3 (running go 1.23.12)
```

**Green**: After fix:
```bash
# In a temp module, verify import works
cd /tmp && mkdir testmod && cd testmod
go mod init testmod
go get github.com/choonkeat/record-tui@<new-commit>
# Should succeed
```

**Refactor**: Run existing test suite to ensure no regressions:
```bash
go test ./...
```

---

## Phase 2: Linux Format Support [DONE]

**Commit**: `6a3daa7` - test: add Linux script format tests for StripMetadata

Note: The existing implementation already handled Linux format correctly. Added tests to document and protect this behavior.

### What Will Be Achieved
The `session.StripMetadata()` function will correctly parse both macOS and Linux `script` header/footer formats.

### Small Steps

1. **Write failing tests first** for Linux format in `internal/session/cleaner_test.go`:
   - Test: Linux header `Script started on 2026-01-12 06:41:43+00:00 [COMMAND="claude" TERM="xterm-256color" ...]`
   - Test: Linux header without the `Command:` line (Linux puts it in brackets)
   - Test: Mixed content with Linux header and standard footer

2. **Update `StripMetadata()` function** in `internal/session/cleaner.go`:
   - Current: Only looks for `"Script started on"` and `"Command:"` as separate lines
   - Change: Also recognize Linux format where metadata is in `[...]` brackets on same line as "Script started on"

3. **Run tests** to verify green

### Verification (TDD Style)

**Red**: Add test cases that fail:
```go
func TestStripMetadata_LinuxFormat(t *testing.T) {
    input := `Script started on 2026-01-12 06:41:43+00:00 [COMMAND="claude" TERM="xterm-256color" TTY="/dev/pts/4" COLUMNS="132" LINES="49"]
actual content here
Script done on 2026-01-12 06:45:00+00:00 [COMMAND_EXIT_STATUS="0"]`

    expected := "actual content here"
    got := StripMetadata(input)
    // Should pass after implementation
}
```

**Green**: Modify `StripMetadata()` to handle Linux format

**Refactor**:
```bash
go test ./internal/session/... -v
go test ./...  # Full suite for regression check
```

---

## Phase 3: Library-Friendly API [DONE]

**Commit**: `028b56a` - feat: add public playback API for library usage

### What Will Be Achieved
A clean public API that both swe-swe **and** record-tui's own `cmd/` can use.

### Small Steps

1. **Create new public package** `playback/` at the root level:
   - `playback/playback.go` - Main API
   - `playback/types.go` - Exported types

2. **Define public types**:
   ```go
   // playback/types.go
   package playback

   type Frame struct {
       Timestamp float64 `json:"timestamp"`
       Content   string  `json:"content"`
   }

   type Options struct {
       Title   string  // Page title
       Footer  string  // Optional custom footer (default: "generated by record-tui")
   }
   ```

3. **Define public functions**:
   ```go
   // playback/playback.go
   package playback

   // StripMetadata removes script header/footer from session log content.
   // Supports both macOS and Linux script formats.
   func StripMetadata(content string) string

   // RenderHTML generates a standalone HTML page with terminal playback.
   func RenderHTML(frames []Frame, opts Options) (string, error)
   ```

4. **Write tests** for the public API in `playback/playback_test.go`

5. **Refactor `cmd/record-tui/main.go`** to use the new public API instead of calling `internal/` packages directly

6. **Refactor `internal/record/converter.go`** to use the public API (or remove if no longer needed)

7. **Update README** with library usage example

### Verification (TDD Style)

**Red**: Write test that uses the public API:
```go
// playback/playback_test.go
func TestRenderHTML(t *testing.T) {
    frames := []Frame{{Timestamp: 0, Content: "hello world"}}
    html, err := RenderHTML(frames, Options{Title: "Test"})
    if err != nil {
        t.Fatal(err)
    }
    if !strings.Contains(html, "hello world") {
        t.Error("expected content in HTML")
    }
}
```

**Green**: Implement public API by delegating to internal packages

**Refactor**:
```bash
go test ./playback/... -v   # New public API tests
go test ./...               # Full suite - ensures cmd still works
```

**End-to-end verification**:

1. **Git push for macOS testing**: Push `expose-api` branch to origin for user to test on Mac:
   ```bash
   git push origin expose-api
   ```

2. **Test container + MCP browser**: Boot test container per `docs/dev/test-container-workflow.md`, generate HTML, and verify playback via MCP browser

---

## Summary

| Phase | Description | Verification |
|-------|-------------|--------------|
| 1 | Fix go.mod version | DONE - `ca9c804` |
| 2 | Linux format support | DONE - `6a3daa7` (already worked, added tests) |
| 3 | Public API | DONE - `028b56a` (converter dogfoods it, tests pass) |

## End-to-End Verification [DONE]

1. **Git push for macOS testing**: DONE - pushed, tested on Mac, works
2. **Test container + MCP browser**: Skipped (macOS test sufficient)
