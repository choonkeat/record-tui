# Terminal Recording Tools: ANSI Code Capture Research

**Date:** 2025-12-29 15:30
**Topic:** Asciinema, alternative terminal recording tools, and ANSI code preservation mechanisms

---

## 1. How Asciinema Captures Terminal Output with ANSI Codes

### Technology/Mechanism

**Asciinema uses Unix Pseudo-Terminals (PTYs)** to capture terminal data:

- A PTY is a pair of pseudo-devices: the **slave** (emulates a real text terminal) and the **master** (controls the slave)
- Asciinema positions itself as the master device between the user and shell
- This architecture intercepts **all textual output** along with **invisible control sequences in their raw form**
- Also captures terminal **resize events** and optional **keyboard input**

**Key Technical Details:**
- PTY captures raw byte streams including ANSI escape sequences
- Raw mode is set on the slave side using `tcgetattr()` / `tcsetattr()` and `cfmakeraw()`
- Raw mode disables canonical mode and echo, handling characters one at a time
- Avoids line buffering or canonical mode processing

### Recording Storage

Asciinema saves sessions in **asciicast format** with timestamped events:
- Every detail of the terminal session is encoded as a sequence of time-stamped events
- Preserves both **content** and the **rhythm/flow** of the session
- Lightweight compared to traditional video recording
- Complete fidelity to the original terminal session

### asciicast v3 Format

Format structure: **newline-delimited JSON**

**Header:** First line contains JSON metadata
- Terminal dimensions (cols, lines)
- Timestamp
- Title
- Environment variables

**Event Stream:** Subsequent lines contain JSON arrays
- Format: `[interval, code, data]`
- `interval`: Time in seconds since previous event
- `code`: Event type (o=output, i=input, m=marker, r=resize, x=exit)
- `data`: Event-specific content (UTF-8 encoded JSON string)

**ANSI Preservation in asciicast v3:**
- ANSI escape sequences are stored as escaped Unicode within JSON strings
- Example: `\u001b[1;31m` represents color escape sequences
- Non-printable Unicode codepoints encoded as `\uXXXX`
- Output player (called **avt**, a custom terminal emulator) interprets ANSI sequences and renders them visually

---

## 2. Alternative Tools for Recording Terminal Sessions with ANSI Codes

### A. script / scriptreplay (POSIX Standard)

**How it works:**
- Built into macOS and Linux (part of GNU util-linux)
- Creates a PTY pair
- Connects stdin/stdout to master side
- Slave side connects to a new shell
- Captures all data flowing through the master to an output file

**ANSI Preservation:**
- **YES** - Output file contains raw terminal data including ANSI escape codes
- Full-screen applications (vim, htop, ncdu) are recorded as control sequences
- Backspacing and cursor movements recorded as control sequences, not just final state

**Basic Usage:**
```bash
# Record session with timing file
script --timing=timing.log session.log

# Or alternative syntax
script -t 2>timing.log session.log
```

**Replay:**
```bash
scriptreplay --timing timing.log session.log
```

**Interactive Replay Features:**
- Speed up: Up arrow key
- Slow down: Down arrow key
- Pause: Space key

**Pros:**
- Built-in (no installation needed on macOS/Linux)
- Preserves ANSI codes
- Minimal overhead
- Can append to existing files with `-a` flag
- Timing file enables speed-matched playback

**Cons:**
- Plain text output (less structured than JSON)
- Older tool, limited modern features
- Output can be large for long sessions

### B. rewindtty

**What it is:**
- Terminal session recorder written in pure C
- Records output to **structured JSON format** with timestamps
- Spawns CLI commands inside a pseudo-terminal

**ANSI Preservation Status:**
- **Currently LIMITED** - ANSI escape sequences are stripped or not preserved
- Cannot capture full-screen TUI programs (vim, htop, ncdu) that rely on ANSI codes
- **Future support planned** - proposal to add option for raw PTY output including ANSI escape sequences

**JSON Format:**
- Structured output for easy parsing
- Can be integrated with other tools programmatically
- Web browser player available on GitHub

**Installation:**
```bash
# Available on most package managers
brew install rewindtty  # macOS
apt-get install rewindtty  # Debian/Ubuntu
```

**Usage:**
```bash
rewindtty -c "npm test" output.json
```

**Pros:**
- Structured JSON output
- Easy to parse and integrate
- Interactive mode available
- Lightweight (C implementation)

**Cons:**
- ANSI support not yet complete
- Cannot handle TUI applications currently
- Newer tool (less tested than script)

### C. Node.js / npm-based Tools

#### terminalizer
- npm package for recording terminal sessions
- Version 0.12.0
- Can compile to GIF output

**Installation:**
```bash
npm install -g terminalizer
```

#### ttstudio
- Node.js CLI application
- Records terminal and compiles to GIF
- No external dependencies needed

#### npm ANSI Handling Libraries
- **ansi** - Module for writing ANSI escape codes to streams
- **node-ansiparser** - Parser for ANSI escape sequences (VT100-compatible)
- **ansi-csi-terminal** - ES6 library for controlling terminal with ANSI codes
- **strip-ansi** - Remove ANSI codes from strings

---

## 3. Capturing Claude Code CLI Output with ANSI Codes

### Using Asciinema

**Recording Claude Code with asciinema:**
```bash
asciinema rec -c "claude-code [command]" output.cast
asciinema rec -c "claude run" output.cast
```

**Example capturing a specific operation:**
```bash
# Record a Claude Code execution
asciinema rec -c "claude run --something" myclaude.cast

# With stdin capture
asciinema rec --stdin -c "claude run" myclaude.cast
```

**Playback:**
```bash
asciinema play output.cast
```

**Upload to asciinema.org:**
```bash
asciinema upload output.cast
```

**Pros:**
- Preserves all colors and formatting
- Lightweight asciicast format
- Easy sharing via asciinema.org
- Can embed in HTML/web pages
- Includes timing information

**Cons:**
- Requires asciinema installation
- Interactive input not captured by default
- Output format requires player (not plain text)

### Using script Command

**Recording Claude Code with script:**
```bash
# Basic recording
script -t 2>timing.log claude-session.log

# Then run Claude Code
# Type your commands...
# Press Ctrl-D to exit

# Example full session
script -t 2>timing.log claude-session.log
claude-code --help
exit

# Replay
scriptreplay --timing timing.log claude-session.log
```

**Pros:**
- No installation needed on macOS
- Preserves ANSI codes completely
- Can automate via script files
- Lightweight output

**Cons:**
- Less polished than asciinema
- Plain text output (requires interpretation)
- Timing data in separate file

### Using rewindtty

**Recording Claude Code with rewindtty:**
```bash
rewindtty -c "claude-code --help" output.json
```

**Limitations:**
- **ANSI codes currently not preserved**
- Suitable for CLI-only output without colors
- Wait for ANSI support implementation before using for colored output

**Pros if ANSI support added:**
- Structured JSON output
- Programmable/parseable

---

## 4. macOS Specific: How script Command Works

### Basic Operation on macOS

```bash
# Record a terminal session
script -t 2>timing.log myrecording.log

# In the script session, run your commands
# Exit with Ctrl-D or type 'exit'

# Replay with timing
scriptreplay --timing timing.log myrecording.log
```

### ANSI Code Support

- **macOS Terminal.app is VT100/ANSI compatible**
- Supports DEC VT100 ANSI control sequences
- Terminal.app supports common escape and control sequences
- ANSI escape codes are preserved by the `script` command

### Common ANSI Code Format

```bash
# Format: \033[<code>m or \e[<code>m

# Colors and attributes:
\e[1;32m     # Bold green
\e[0m        # Reset all attributes
\e[31m       # Red text
\e[42m       # Green background
\e[1;4;31m   # Bold, underline, red

# Example in echo
echo -e "\e[1;32mSuccess\e[0m"  # Prints "Success" in bold green
```

### Enabling Colors in Terminal Recording

**Set environment variables before recording:**
```bash
# Enable terminal color detection
export CLICOLOR=1
export CLICOLOR_FORCE=1
export COLORTERM=truecolor  # Signals 24-bit RGB support

# Then record
script -t 2>timing.log session.log
claude-code --help
```

### Gotchas with Interactive CLIs

1. **Input buffering:** Some CLIs buffer input differently in PTY mode
2. **TTY detection:** Programs may detect they're in a script and disable colors
   - Solution: Use `FORCE_COLOR=1` or `--color=always` flags
3. **Terminal size:** PTY may have different size than interactive terminal
   - Set size before recording: `stty rows 24 cols 80`
4. **Escape sequence handling:** Some programs may not work perfectly in PTY
   - Test interactive behavior by replaying

---

## 5. Node.js / npm Packages for ANSI Capture

### Recording with npm Packages

**Option 1: Using terminalizer**
```bash
npm install -g terminalizer

# Record
terminalizer record demo

# Play
terminalizer play demo

# Export to GIF
terminalizer render demo -o demo.gif
```

**Option 2: Using custom Node.js wrapper**
```javascript
const { spawn } = require('child_process');
const fs = require('fs');

// Spawn process preserving colors
const proc = spawn('claude-code', ['--help'], {
  stdio: ['pipe', 'pipe', 'pipe'],
  env: {
    ...process.env,
    FORCE_COLOR: '1',
    COLORTERM: 'truecolor'
  }
});

// Capture output with ANSI codes intact
proc.stdout.pipe(fs.createWriteStream('output.txt'));
proc.stderr.pipe(fs.createWriteStream('error.txt'));
```

### ANSI Parsing Libraries

**Parse ANSI codes programmatically:**
```bash
npm install node-ansiparser ansi strip-ansi
```

**Example usage:**
```javascript
const parser = require('node-ansiparser');
const stripAnsi = require('strip-ansi');

// Parse ANSI output
const output = "\u001b[1;31mError\u001b[0m";
const cleaned = stripAnsi(output);  // "Error"

// Parse and handle codes
parser.parse(output, {
  onText: (txt) => console.log('Text:', txt),
  onExecute: (code) => console.log('Escape:', code)
});
```

---

## 6. Comparison Table

| Tool | ANSI Support | Format | PTY-Based | Pros | Cons |
|------|---|---|---|---|---|
| **asciinema** | Yes | asciicast v3 (JSON) | Yes | Easy sharing, lightweight, web playable | Requires installation, tool-specific format |
| **script** | Yes | Raw text + timing | Yes | Built-in macOS/Linux, minimal overhead | Plain text, large files for long sessions |
| **scriptreplay** | Yes (for replay) | Raw text + timing | Yes | Fast replay with timing, built-in | Requires script command, separate timing file |
| **rewindtty** | No (planned) | JSON | Yes | Structured format, programmable | ANSI not yet supported, newer tool |
| **terminalizer** | Yes | Proprietary + GIF | Maybe | Nice GIF output, npm-based | Less feature-rich, smaller ecosystem |

---

## 7. Recommended Approach for Claude Code CLI

### For Local Testing/Debugging
**Use `script` command:**
```bash
# Set color flags
export FORCE_COLOR=1
export COLORTERM=truecolor

# Record session with timing
script -t 2>timing.log claude_session.log

# Run Claude Code commands
claude-code --help
exit

# Replay
scriptreplay --timing timing.log claude_session.log
```

### For Sharing/Documentation
**Use asciinema:**
```bash
asciinema rec -c "claude-code --help" demo.cast

# Upload
asciinema upload demo.cast

# Get shareable link and embed code
```

### For CI/CD or Programmatic Capture
**Use Node.js wrapper** with spawn() and file piping, or wait for **rewindtty ANSI support**.

---

## 8. Key Findings Summary

1. **PTY Wrapping is Standard** - Both asciinema and script use Unix PTYs to capture raw terminal data
2. **ANSI Codes Preserved** - Raw PTY output includes all ANSI escape sequences when captured properly
3. **Format Matters** - Choose between human-readable (script) or structured (asciicast, JSON)
4. **Color Flags Important** - Must set FORCE_COLOR=1, CLICOLOR=1, or similar to prevent programs from detecting script mode and disabling colors
5. **macOS Compatible** - script command works perfectly on macOS, preserves ANSI codes
6. **rewindtty is Promising** - Structured JSON approach is ideal but ANSI support pending
7. **Claude Code Friendly** - All methods should work with Claude Code as long as terminal detection flags are set

